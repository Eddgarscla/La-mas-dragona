<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Episodio - La Más Draga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      min-height: 100vh;
      background-image: url('WhatsApp Image 2025-12-01 at 07.24.11.jpeg');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center top;
      color: white;
      overflow-x: hidden;
      padding: env(safe-area-inset-top) 10px 30px;
      box-sizing: border-box;
    }

    .sim-panel {
      max-width: 430px;
      margin: 70px auto 40px;
      padding: 18px 18px 24px;
      background: rgba(0, 0, 0, 0.45);
      border-radius: 26px;
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.75);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 2rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: linear-gradient(90deg, #ffd700, #ff69b4, #7b5dff);
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(0,0,0,0.9);
    }

    h2.sectionTitle {
      margin: 14px 0 6px;
      font-size: 1.12rem;
      text-transform: uppercase;
      text-shadow:0 0 10px black;
    }

    .episodeRow {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }

    .episodeRow img {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ff69b4;
    }

    .episodeText span {
      font-size: 0.82rem;
    }

    .perf-excellent img { border-color:#00ff9d; }
    .perf-bad img { border-color:#ffd54a; }
    .perf-awful img { border-color:#ff3b6b; filter: brightness(1.1); }

    .winnerCard {
      text-align: center;
      margin-top: 12px;
    }
    .winnerCard img {
      width: 85px; height: 85px; border-radius: 50%;
      border: 4px solid gold;
    }

    .lipSyncRow img { border-color:#ff3b6b; }

    .outQueen img {
      filter: grayscale(100%);
      border-color: red;
    }

    #nextBtn {
      width: 80%;
      max-width: 260px;
      margin: 20px auto 0;
      display: block;
      padding: 12px;
      background: linear-gradient(135deg,#ff37b3,#ff70d6);
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(255,20,147,0.9);
    }
    #nextBtn:disabled {
      opacity: 0.4;
      box-shadow: none;
    }

  </style>
</head>

<body>
  <div class="sim-panel">
    <h1 id="episodeTitle"></h1>
    <p id="episodeSubtitle"></p>
    <div id="episodeContent"></div>
    <button id="nextBtn">La más…</button>
  </div>

  <script>

    const cast = JSON.parse(localStorage.getItem("lmd_selectedQueens") || "[]");

    if (!cast.length) {
      document.getElementById("episodeTitle").textContent = "No hay cast cargado";
      document.getElementById("nextBtn").disabled = true;
    }

    let aliveQueens = cast.slice();
    let trackRecord = {};
    let episodeNumber = 1;
    let currentEpisode = null;
    let step = -1;

    const performanceLabels = {
      excellent: "Excelente",
      good: "Salvada",
      bad: "Casi menos",
      awful: "Menos"
    };

    function buildEpisode() {
      const shuffled = aliveQueens.slice().sort(()=>Math.random()-0.5);
      const n = shuffled.length;

      const winner = shuffled[0];
      const lipsyncPair = n>=3 ? [shuffled[n-1], shuffled[n-2]] : [shuffled[n-1]];

      const eliminated = lipsyncPair.length===2 ? lipsyncPair[Math.floor(Math.random()*2)] : lipsyncPair[0];
      const safeFromLipsync = lipsyncPair[0]===eliminated ? lipsyncPair[1] : lipsyncPair[0];

      const challengeName = `La más Episodio ${episodeNumber}`;

      currentEpisode = {
        challenge: challengeName,
        winner,
        lipsyncPair,
        eliminated,
        safeFromLipsync
      };

      // TrackRecord update
      aliveQueens.forEach(q=>{
        if (!trackRecord[q.name]) trackRecord[q.name]=[];
        if (q===winner) trackRecord[q.name].push("La +");
        else if (lipsyncPair.includes(q) && q!==eliminated) trackRecord[q.name].push("La -");
        else if (q===eliminated) trackRecord[q.name].push("OUT");
        else trackRecord[q.name].push("SAFE");
      });

    }

    function render() {

      const title = document.getElementById("episodeTitle");
      const sub = document.getElementById("episodeSubtitle");
      const content = document.getElementById("episodeContent");
      content.innerHTML = "";

      switch(step){
        case -1:
          title.textContent="La más…";
          sub.textContent="Pulsa para revelar el reto";
          break;

        case 0:
          title.textContent=currentEpisode.challenge;
          sub.textContent="Ganadora del reto";
          content.innerHTML = `
            <div class="winnerCard">
              <img src="${currentEpisode.winner.image}">
              <p>${currentEpisode.winner.name}</p>
            </div>`;
          break;

        case 1:
          title.textContent="Lip Sync";
          sub.textContent="Las menos del reto";
          currentEpisode.lipsyncPair.forEach(q=>{
            content.innerHTML+=`
             <div class="episodeRow perf-awful">
              <img src="${q.image}"><span>${q.name}</span>
             </div>`;
          });
          break;

        case 2:
          title.textContent="Resultado del Lip Sync";
          sub.textContent="";
          content.innerHTML = `
            <div class="episodeRow safeQueen"><img src="${currentEpisode.safeFromLipsync.image}"><span>${currentEpisode.safeFromLipsync?.name}</span></div>
            <div class="episodeRow outQueen"><img src="${currentEpisode.eliminated.image}"><span>${currentEpisode.eliminated.name}</span></div>`;
          break;

        case 3:
          title.textContent="Track Record";
          sub.textContent="Resumen de la temporada";

          cast.forEach(q=>{
            const marks = trackRecord[q.name] || [];
            const mark = marks[episodeNumber-1];
            content.innerHTML+=`
              <div class="episodeRow">
                <img src="${q.image}">
                <span>${q.name}</span>
                <span style="margin-left:auto">${mark || "-"}</span>
              </div>`;
          });

          break;
      }
    }

    document.getElementById("nextBtn").addEventListener("click", ()=>{
      if(step===-1){
        buildEpisode();
        step=0;
      }
      else{
        step++;
      }

      // después del track record
      if(step===4){
        aliveQueens = aliveQueens.filter(q=> q!==currentEpisode.eliminated);
        step = -1;
        episodeNumber++;

        if(aliveQueens.length<=4){
          document.getElementById("nextBtn").textContent="Gran Final (pronto)";
          document.getElementById("nextBtn").disabled = true;
        }
      }

      render();
    });

    render();

  </script>

</body>
</html>
