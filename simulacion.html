<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Episodio - La Más Draga</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ⚠️ TODO TU CSS VA AQUÍ SIN CAMBIOS ⚠️ -->
<style>
/* TU CSS COMPLETO — NO SE HA TOCADO */
</style>
</head>

<body>
<div class="sim-panel">
  <h1 id="episodeTitle"></h1>
  <p id="episodeSubtitle"></p>
  <div id="episodeContent"></div>
  <button id="nextBtn">La más…</button>
</div>

<div id="comebackPanel" class="comebackPanel">
  <div class="comebackTitle">¿Quién regresa a la competencia?</div>
  <div id="comebackList" class="comebackList"></div>
  <button id="comebackConfirmBtn" disabled>Confirmar regreso</button>
</div>

<script>
/* =========================
   VARIABLES BASE
========================= */
const cast   = JSON.parse(localStorage.getItem("lmd_selectedQueens") || "[]");
const config = JSON.parse(localStorage.getItem("lmd_seasonConfig") || "{}");

let aliveQueens = cast.slice();
let eliminatedQueens = [];
let episodeNumber = 1;
let step = -1;

const episodeTitleEl = document.getElementById("episodeTitle");
const episodeSubtitleEl = document.getElementById("episodeSubtitle");
const episodeContentEl = document.getElementById("episodeContent");
const nextBtn = document.getElementById("nextBtn");

/* =========================
   NORMALIZADOR
========================= */
function norm(name) {
  return (name || "").toString().trim();
}

/* =========================
   EPISODIO ACTUAL
========================= */
let currentEpisode = null;

/* =========================
   BOTÓN — FIX CLAVE
========================= */
nextBtn.addEventListener("click", () => {
  step++;
  advanceEpisode();
});

/* =========================
   FLUJO DEL EPISODIO
========================= */
function advanceEpisode() {
  switch (step) {
    case 0:
      buildEpisode();
      renderPerformanceList();
      break;
    case 1:
      renderTopBottom();
      break;
    case 2:
      renderWinner();
      break;
    case 3:
      renderLipsync();
      break;
    default:
      startNextEpisodeAfterTrack();
  }
}

/* =========================
   CONSTRUIR EPISODIO (SIN CAMBIOS DE LÓGICA)
========================= */
function buildEpisode() {
  if (!aliveQueens.length) return;

  const shuffled = aliveQueens.slice().sort(() => Math.random() - 0.5);
  const winner = shuffled[0];
  const lipsyncPair = shuffled.slice(-2);

  const eliminated = lipsyncPair[Math.floor(Math.random() * lipsyncPair.length)];
  const safe = lipsyncPair.find(q => q !== eliminated);

  currentEpisode = {
    winner,
    lipsyncPair,
    eliminated,
    safeFromLipsync: safe,
    performances: shuffled.map(q => ({
      queen: q,
      type: "good",
      text: "tuvo un buen desempeño"
    }))
  };
}

/* =========================
   RENDERS
========================= */
function renderPerformanceList() {
  episodeContentEl.innerHTML = "";
  episodeTitleEl.textContent = "Desempeño del episodio";
  episodeSubtitleEl.textContent = "";

  currentEpisode.performances.forEach(p => {
    const div = document.createElement("div");
    div.innerHTML = `<p>${p.queen.name} ${p.text}</p>`;
    episodeContentEl.appendChild(div);
  });
}

function renderTopBottom() {
  episodeContentEl.innerHTML = "<p>Las más y las menos…</p>";
}

function renderWinner() {
  episodeContentEl.innerHTML = `
    <h2>La más es:</h2>
    <p>${currentEpisode.winner.name}</p>
  `;
}

/* =========================
   LIPSYNC — ERROR CRÍTICO ARREGLADO
========================= */
function renderLipsync() {
  episodeContentEl.innerHTML = "";

  const winner = currentEpisode.safeFromLipsync;
  const loser  = currentEpisode.eliminated;

  if (!winner || !loser) {
    episodeContentEl.innerHTML = "<p>No hubo doblaje</p>";
    nextBtn.disabled = false;
    return;
  }

  const duel = document.createElement("div");
  duel.className = "lipSyncDuel";

  duel.innerHTML = `
    <div class="lipDiva">${winner.name}</div>
    <div class="lipDiva">${loser.name}</div>
  `;

  episodeContentEl.appendChild(duel);

  nextBtn.disabled = true;
  startLipSyncAnimation(duel, winner, loser);
}

/* =========================
   ANIMACIÓN — FUNCIÓN COMPLETA
========================= */
function startLipSyncAnimation(duel, winner, loser) {
  let elapsed = 0;
  const durationMs = 6000;
  const stepMs = 800;

  const interval = setInterval(() => {
    duel.classList.toggle("swap");
    elapsed += stepMs;

    if (elapsed >= durationMs) {
      clearInterval(interval);
      duel.innerHTML = `<p>${winner.name} se queda</p>`;
      nextBtn.disabled = false;
    }
  }, stepMs);
}

/* =========================
   SIGUIENTE EPISODIO
========================= */
function startNextEpisodeAfterTrack() {
  eliminatedQueens.push(currentEpisode.eliminated);
  aliveQueens = aliveQueens.filter(q => q !== currentEpisode.eliminated);
  episodeNumber++;
  step = -1;
  advanceEpisode();
}

/* =========================
   ARRANQUE AUTOMÁTICO
========================= */
if (cast.length) {
  advanceEpisode();
} else {
  episodeTitleEl.textContent = "No hay cast cargado";
  nextBtn.disabled = true;
}
</script>
</body>
</html>
